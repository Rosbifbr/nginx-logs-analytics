// SAMPLE
// 109.125.169.52 - - [26/Jan/2019:20:29:13 +0330] "GET / HTTP/1.1" 200 29950 "http://ptcnovin.com/viewads/4B534D5O05649374H5E3235D95EB6C67BE55371115H545745731C7BU17B536Z33C69U46DZV569O7042364B566HV35EO757496" "Mozilla/5.0 (Windows NT 6.1; rv:64.0) Gecko/20100101 Firefox/64.0" "-"
// 5.113.60.62 - - [26/Jan/2019:20:29:13 +0330] "GET /static/images/amp/instagram.png HTTP/1.1" 200 7146 "https://www.zanbil.ir/m/article/616/%D8%B9%D9%84%D8%AA-%D8%AE%D9%88%D8%A7%D8%A8-%D8%B1%D9%81%D8%AA%D9%86%D8%8C%DA%AF%D8%B2%DA%AF%D8%B2%D8%8C%D8%A8%DB%8C-%D8%AD%D8%B3%DB%8C-%D9%88-%D9%85%D9%88%D8%B1-%D9%85%D9%88%D8%B1-%D8%B4%D8%AF%D9%86-%D8%A7%D9%86%DA%AF%D8%B4%D8%AA%D8%A7%D9%86-%D8%AF%D8%B3%D8%AA-%D9%88-%D8%AF%D8%B1%D9%85%D8%A7%D9%86-%D8%A2%D9%86" "Mozilla/5.0 (Linux; Android 8.0.0; SAMSUNG SM-G570F Build/R16NW) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/8.2 Chrome/63.0.3239.111 Mobile Safari/537.36" "-"
// 5.113.60.62 - - [26/Jan/2019:20:29:13 +0330] "GET /static/images/amp/telegram.png HTTP/1.1" 200 4859 "https://www.zanbil.ir/m/article/616/%D8%B9%D9%84%D8%AA-%D8%AE%D9%88%D8%A7%D8%A8-%D8%B1%D9%81%D8%AA%D9%86%D8%8C%DA%AF%D8%B2%DA%AF%D8%B2%D8%8C%D8%A8%DB%8C-%D8%AD%D8%B3%DB%8C-%D9%88-%D9%85%D9%88%D8%B1-%D9%85%D9%88%D8%B1-%D8%B4%D8%AF%D9%86-%D8%A7%D9%86%DA%AF%D8%B4%D8%AA%D8%A7%D9%86-%D8%AF%D8%B3%D8%AA-%D9%88-%D8%AF%D8%B1%D9%85%D8%A7%D9%86-%D8%A2%D9%86" "Mozilla/5.0 (Linux; Android 8.0.0; SAMSUNG SM-G570F Build/R16NW) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/8.2 Chrome/63.0.3239.111 Mobile Safari/537.36" "-"
// 5.113.60.62 - - [26/Jan/2019:20:29:13 +0330] "GET /static/images/amp/blog.png HTTP/1.1" 200 3863 "https://www.zanbil.ir/m/article/616/%D8%B9%D9%84%D8%AA-%D8%AE%D9%88%D8%A7%D8%A8-%D8%B1%D9%81%D8%AA%D9%86%D8%8C%DA%AF%D8%B2%DA%AF%D8%B2%D8%8C%D8%A8%DB%8C-%D8%AD%D8%B3%DB%8C-%D9%88-%D9%85%D9%88%D8%B1-%D9%85%D9%88%D8%B1-%D8%B4%D8%AF%D9%86-%D8%A7%D9%86%DA%AF%D8%B4%D8%AA%D8%A7%D9%86-%D8%AF%D8%B3%D8%AA-%D9%88-%D8%AF%D8%B1%D9%85%D8%A7%D9%86-%D8%A2%D9%86" "Mozilla/5.0 (Linux; Android 8.0.0; SAMSUNG SM-G570F Build/R16NW) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/8.2 Chrome/63.0.3239.111 Mobile Safari/537.36" "-"
// 5.113.60.62 - - [26/Jan/2019:20:29:13 +0330] "GET /static/images/amp/third-party/footer-mobile.png HTTP/1.1" 200 62894 "https://www.zanbil.ir/m/article/616/%D8%B9%D9%84%D8%AA-%D8%AE%D9%88%D8%A7%D8%A8-%D8%B1%D9%81%D8%AA%D9%86%D8%8C%DA%AF%D8%B2%DA%AF%D8%B2%D8%8C%D8%A8%DB%8C-%D8%AD%D8%B3%DB%8C-%D9%88-%D9%85%D9%88%D8%B1-%D9%85%D9%88%D8%B1-%D8%B4%D8%AF%D9%86-%D8%A7%D9%86%DA%AF%D8%B4%D8%AA%D8%A7%D9%86-%D8%AF%D8%B3%D8%AA-%D9%88-%D8%AF%D8%B1%D9%85%D8%A7%D9%86-%D8%A2%D9%86" "Mozilla/5.0 (Linux; Android 8.0.0; SAMSUNG SM-G570F Build/R16NW) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/8.2 Chrome/63.0.3239.111 Mobile Safari/537.36" "-"
// 188.229.21.56 - - [26/Jan/2019:20:29:13 +0330] "GET /content/view/shoppingRules HTTP/1.1" 302 0 "https://www.zanbil.ir/m/product/32106/62372/%D9%85%D8%A7%D8%B4%DB%8C%D9%86-%D9%84%D8%A8%D8%A7%D8%B3%D8%B4%D9%88%DB%8C%DB%8C-%D8%AF%D8%B1%D8%A8-%D8%A7%D8%B2-%D8%AC%D9%84%D9%88-%D8%A7%D9%84-%D8%AC%DB%8C-%D9%85%D8%AF%D9%84-WM-865CW" "Mozilla/5.0 (Linux; Android 7.0; SM-N920C Build/NRD90M) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Mobile Safari/537.36" "-"
// 5.127.220.71 - - [26/Jan/2019:20:29:13 +0330] "GET /apple-touch-icon-120x120.png HTTP/1.1" 404 32420 "-" "MobileSafari/604.1 CFNetwork/976 Darwin/18.2.0" "-"
// 5.213.7.50 - - [26/Jan/2019:20:29:13 +0330] "GET /m/product/18962/%D8%BA%D8%B0%D8%A7-%D8%B3%D8%A7%D8%B2-%D9%85%D9%88%D9%84%DB%8C%D9%86%DA%A9%D8%B3-%D9%85%D8%AF%D9%84-FP7367RT HTTP/1.1" 200 20959 "https://www.google.com/" "Mozilla/5.0 (iPhone; CPU iPhone OS 10_2_1 like Mac OS X) AppleWebKit/602.4.6 (KHTML, like Gecko) Version/10.0 Mobile/14D27 Safari/602.1" "-"
// 109.125.169.52 - - [26/Jan/2019:20:29:13 +0330] "GET /image/%7B%7BbasketItem.id%7D%7D?type=productModel&wh=50x50 HTTP/1.1" 200 5 "https://www.zanbil.ir/" "Mozilla/5.0 (Windows NT 6.1; rv:64.0) Gecko/20100101 Firefox/64.0" "-"
// 37.129.59.160 - - [26/Jan/2019:20:29:13 +0330] "GET /basket/view HTTP/1.1" 200 17299 "https://www-zanbil-ir.cdn.ampproject.org/v/s/www.zanbil.ir/m/product/32148/%DA%AF%D9%88%D8%B4%DB%8C-%D8%AA%D9%84%D9%81%D9%86-%D8%A8%DB%8C-%D8%B3%DB%8C%D9%85-%D9%BE%D8%A7%D9%86%D8%A7%D8%B3%D9%88%D9%86%DB%8C%DA%A9-%D9%85%D8%AF%D9%84-Panasonic-Cordless-Telephone-KX-TGC412?amp_js_v=0.1&usqp=mq331AQECAEoAQ%3D%3D" "Mozilla/5.0 (Linux; Android 6.0.1; D6633 Build/23.5.A.1.291) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Mobile Safari/537.36" "-"

import { createWriteStream, createReadStream } from 'fs';
import { createInterface } from 'readline';
const sc = ',' //separator

const writeStream = createWriteStream('proc', { flags: 'a' });
writeStream.write(['IP', 'Date', 'Time', 'Hour', 'Method', 'Status', 'Bytes', 'PathName', 'RootPath', 'SubPath'].join(sc) + '\n');

const lineReader = createInterface({
  input: createReadStream('access.log')
});

let count = 0

lineReader.on('line', (line) => {
  if (line.trim() !== '') {
    const parts = line.replaceAll(sc, '').split(' ');
    const fullDate = parts[3].replace('[', '').replace(']', '').replace(':', ' ').replace('/', '-').replace('/', '-').split(' ');
    const timeSeconds = fullDate[1].split(":").map((e, i) => parseInt(e) * 60 ** (2 - i)).reduce((a, c) => a + c, 0)
    const hour = fullDate[1].split(":")[0]
    const reqPath = parts[6].split('/');

    const csvLine = [
      parts[0], // IP
      fullDate.join(" "),
      timeSeconds, //we want the number of seconds of day here to plot
      fullDate[0] + hour, //we want the hod here to plot
      parts[5].replace('"', ''), // Method
      parts[8], // Status
      parts[9], // Bytes
      parts[6], // URL
      reqPath[1], //rootpath (good for classifying)
      reqPath[2], //subpath (good for classifying)
    ].join(sc);
    writeStream.write(csvLine + '\n');
    count++
    if (count % 1000 === 0) {
      process.stdout.write("\r" + count)
    }
  }
});
